---
title: "Regression methods - Accidents"
author: "candice"
date: "2022-11-18"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r packages, include=FALSE, echo=FALSE}
lapply(c("dplyr","chron","ggplot2","tidyr","questionr","survival","forcats",
         "data.table","table1","lubridate", "ggpubr","viridis","finalfit",
         "ggpubr", "ggthemes", "gridExtra", "tidyverse", "rstatix","ggsci",
         "wesanderson","kableExtra", "naniar","boot","scales","psych","ggcorrplot","ggradar", "caret"), 
       library, character.only=TRUE)

Sys.setlocale("LC_TIME", "English")
setwd("C:/Users/candi/Desktop/ETUDES/EPFL1A/semestre 1/regression methods/project")
load("C:/Users/candi/Desktop/ETUDES/EPFL1A/semestre 1/regression methods/project/Accidents.RData")

```

## Exploratory
visualisation of the number of accidents : 
```{r }
Accidents %>% group_by(Acc) %>% summarise(number=n()) %>% mutate(freq = number/sum(number)) %>% 
  ggplot(aes(x=Acc, y = freq)) + geom_bar(stat='identity')

```
comment : the distribution looks like an exponential/poisson distribution, there is one obvious outlier (Acc>80), and some possible outliers (at 50)

Let's try to fit an exponential ditribution.
```{r , echo=FALSE}
mean(Accidents$Acc) #to fit the exponential model

p<-data.frame(rexp(100,0.25))
ggplot(p,aes(x=p[,1]))+
  geom_histogram(aes(y=..density..), alpha=0.4, position="identity", lwd=0.1)+
  geom_density(alpha=0.5, lwd=1, bw=0.5)+
  ggtitle("exp(0.25)")
```

Correlations
```{r , echo=FALSE}
## Plot of covariates against each other to look at dependencies (slide 55)
#numerical variables 
panel.hist <- function(x, ...)
{
  usr <- par("usr"); on.exit(par(usr))
  par(usr = c(usr[1:2], 0, 1.5) )
  h <- hist(x, plot = FALSE)
  breaks <- h$breaks; nB <- length(breaks)
  y <- h$counts; y <- y/max(y)
  rect(breaks[-nB], 0, breaks[-1], y, col = "cyan", ...)
}

panel.cor <- function(x, y, digits = 2, prefix = "", cex.cor, ...)
{
  usr <- par("usr"); on.exit(par(usr))
  par(usr = c(0, 1, 0, 1))
  r <- abs(cor(x, y))
  txt <- format(c(r, 0.123456789), digits = digits)[1]
  txt <- paste0(prefix, txt)
  if(missing(cex.cor)) cex.cor <- 0.8/strwidth(txt)
  text(0.5, 0.5, txt, cex = cex.cor * r)
}


#numerical variables
pairs(~ Acc + Traffic + HGV + Slope + Limit + Length + Width + Lanes,data=Accidents, upper.panel = panel.cor, diag.panel = panel.hist)
#categorical variables  ?
```

It looks like the Accidents are mostly correlated with Lanes and Traffic but also HGV and Limit. However Lanes is correlated with Length, Traffic and HGV.

Traffic vs Accidents
```{r , echo=FALSE}
plot(Accidents$Traffic, Accidents$Acc)
```
comment: some extreme values after 1.2 e+08 in Traffic and at 80 in Acc\

Linear model between Traffic and Accidents. No homoscedasticity, R squared is not that good, but the coefficients are significant. 
```{r}
lm.traffic <- lm(Acc ~ Traffic, data=Accidents)
summary(lm.traffic)
plot(Accidents$Traffic, Accidents$Acc)
abline(lm.traffic)

plot(residuals(lm.traffic), fitted(lm.traffic)) 
``` 
Log scale may be more appropriate. When I plot, the distribution doesn't look linear at all. The coefficients are significative but the residuals are not homoscedastic.

```{r}
lm.log.traffic <- lm(Acc ~ log(Traffic), data=Accidents)
summary(lm.log.traffic)

plot(log(Accidents$Traffic), Accidents$Acc)
abline(lm.log.traffic)

plot(residuals(lm.log.traffic), fitted(lm.log.traffic))
```
Below I plot Accidents vs HGV and Accidents vs log(HGV)
```{r , echo=FALSE}
plot(Accidents$HGV, Accidents$Acc)
plot(log(Accidents$HGV), Accidents$Acc)
```
comment : some extreme values of HGV at 0.6?, looks like an exponential distribution 

The linear models don't look good neither with HGV nor with log(HGV)
```{r HGV}
lm.HGV <- lm(Acc ~ HGV, data=Accidents)
summary(lm.HGV)
plot(Accidents$HGV, Accidents$Acc)
abline(lm.HGV)

lm.log.HGV<- lm(Acc ~ log(HGV+1), data=Accidents)
summary(lm.log.HGV)
plot(log(Accidents$HGV), Accidents$Acc)
abline(lm.log.HGV)
``` 


Some models I tried but I am not convinced 
```{r Slope, echo=FALSE}
plot(Accidents$Slope,Accidents$Acc)
#comment : looks almost normal, big concentration at 0 where there are greater number of accidents 
hist(Accidents$Slope)
#comment : looking at the distribution of Slope, it seems quite logical because there are more tunnels with a slope of 0, normal distribution
summary(glm(Acc~Slope, family=gaussian, data=Accidents))
#AIC is 7993.2 and the slope coefficient is not significative
```

```{r , echo=FALSE}
plot(Accidents$Length, Accidents$Acc)
#comment : some extreme values for the length
test <- glm((Acc+1) ~ Length, family=Gamma, data=Accidents)
summary(test,dispersion=1)
#AIC is 6137.5 and the Length coefficient is significative
f <- function(x, param){
  return(param*exp(-param*x))
}
x <- seq(0,12000,by=0.01)
plot(Accidents$Length, Accidents$Acc)
#hist(Accidents$Acc)
```

Some plots I don't know what to do with

```{r , echo=FALSE}
plot(Accidents$Limit, Accidents$Acc)
#comment : idk


plot(Accidents$Width, Accidents$Acc)
#comment : idk
```

Lanes 
```{r , echo=FALSE}
plot(Accidents$Lanes, Accidents$Acc)
Accidents %>% group_by(Lanes, Acc)%>% summarise(number=n())%>% mutate(nb_acc = number*Acc) %>%
  ggplot(aes(x=Lanes, y=nb_acc)) + geom_bar(stat = 'identity')
#comment : it looks like for small and big lanes, there are less accidents but when we look at the distribution of the lanes:
hist(Accidents$Lanes)
#there are very few lanes=5 
LinReg <- lm(Acc ~ Lanes, data=Accidents)
plot(Accidents$Lanes, Accidents$Acc,bg="red")
abline(LinReg, lwd=3, col="blue")
#not convincing to me
```

Categorical variables :
```{r , echo=FALSE}
#year
Accidents%>% group_by(Year, Acc)%>% summarise(number=n())%>% mutate(nb_acc = number*Acc) %>%
  ggplot(aes(x=Year, y=nb_acc)) + geom_bar(stat = 'identity')
#comment : number of accidents is increasing with the years
```

```{r , echo=FALSE}
#Urban
Accidents%>%group_by(Urban, Acc)%>% summarise(number=n())%>%mutate(nb_acc=number*Acc)%>% 
  ggplot(aes(x=Urban, y=nb_acc)) + geom_bar(stat='identity')
#comment : most accidents are in an urban environment
```

```{r , echo=FALSE}
Accidents%>%group_by(Type, Acc)%>% summarise(number=n())%>%mutate(nb_acc=number*Acc)%>% 
  ggplot(aes(x=Type, y=nb_acc)) + geom_bar(stat='identity')
#comment : most accidents are in an unidirectional tunnel 
```

```{r , echo=FALSE}
Accidents%>%group_by(Direction, Acc)%>% summarise(number=n())%>%mutate(nb_acc=number*Acc)%>% 
  ggplot(aes(x=Direction, y=nb_acc)) + geom_bar(stat='identity')
#comment : more accidents are in direction 1 but significatitiveness ? 
```

```{r , echo=FALSE}
Accidents%>%group_by(SlopeType, Acc)%>% summarise(number=n())%>%mutate(nb_acc=number*Acc)%>% 
  ggplot(aes(x=SlopeType, y=nb_acc)) + geom_bar(stat='identity')
#comment : unknown parameters -> we will have to deal with missing data 
#comment : most accidents are in a continuous slope and in basin
```

```{r , echo=FALSE}
Accidents%>%group_by(Tunnel, Acc)%>% summarise(number=n())%>%mutate(nb_acc=number*Acc)%>% 
  ggplot(aes(x=Tunnel, y=nb_acc)) + geom_bar(stat='identity')
#comment : big differences between the different companies, very heterogeneous

```

```{r , echo=FALSE}
Accidents%>%group_by(Company, Acc)%>% summarise(number=n())%>%mutate(nb_acc=number*Acc)%>% 
  ggplot(aes(x=Company, y=nb_acc)) + geom_bar(stat='identity')
#comment : big differences between the different companies, very heterogeneous
```

## Some first models
Linear regression with all the variables 

```{r, echo=FALSE}
Reg <- lm(Acc ~ ., data = Accidents)
summary(Reg)
par(mfrow=c(2,2))
plot(Reg)
```


Without tunnel and company
```{r, echo=FALSE}
Reg2 <- lm(Acc ~ Traffic + HGV + Slope + Limit 
           + Length + Width + Lanes + Direction + Urban + Type + SlopeType, data=Accidents)
summary(Reg2)
plot(Reg2)
```

Without the categorical variables
```{r, echo=FALSE}
Reg3 <- lm(Acc ~ Traffic + HGV + Slope + Limit 
           + Length + Width + Lanes , data=Accidents)
summary(Reg3)
#Slope and HGV do not seem to have an effect; idem for lanes, direction and urban
plot(Reg3)
plot(predict(Reg3, newdata=Accidents[, -14]), rstandard(Reg3), xlab = 'Fitted values', ylab = 'Standardized residuals') 
#residuals aren't normal, outliers at 62, 1140
```

Standardised residuals
```{r, echo=FALSE}
resstan <- rstandard(Reg3)
for (i in colnames(Accidents)) {
  plot(Accidents[[i]], resstan, xlab = i, ylab = 'Standardized residuals')
}
```

Without slope and HGV

```{r, echo=FALSE}
Reg4 <- lm(Acc ~ Traffic + Limit 
              + Length + Width + Lanes , data=Accidents)
summary(Reg4)
```

Log transformation 
```{r, echo=FALSE}
Reg5 <- lm(log(Acc+1) ~ Traffic + Limit 
           + Length + Width + Lanes , data=Accidents)
summary(Reg5)
plot(Reg5)
```

Without length
```{r, echo=FALSE}
Reg6 <- lm(log(Acc+1) ~ Traffic + Limit 
           + Width + Lanes , data=Accidents)
summary(Reg6)
```


## Mixed models  
The idea here would be to consider random and fixed effects :\
  *random : tunnel, company, year, 
  *fixed : Traffic, Lanes, Width, Type, Length, Limit, Slope\
  

Trying to cluster by tunnel : the idea is that the tunnels have random effects whereas the Traffic and Lanes are fixed effects. I don't really understand the models below, I don't know how to interpret.
```{r Mixed model Lanes and log(Traffic) by Tunnel}
library('lme4')
summary(lmer(Acc ~ log(Traffic) + Lanes + Width + Type + log(Length) + Limit + Slope + (1 | Tunnel), data = Accidents))
``` 

```{r mixed model by company}
library('lme4')
summary(lmer(Acc ~ log(Traffic) + Lanes + Width + Type + log(Length) + Limit + Slope + (1 | Company), data = Accidents))
``` 

```{r Nested effects test}
summary( aov(Acc ~ Traffic/Tunnel, data=Accidents) )
summary( aov(Acc ~ Traffic + Tunnel, data=Accidents) )

summary( aov(Acc ~ Traffic/Company, data=Accidents) )
``` 


## Fitting a Poisson model ? 
The summary is quite excellent but the QQplot is skewed. 
```{r, echo=FALSE}
m1 <- glm(Acc ~ Lanes + Traffic, family="poisson", data=Accidents)
summary(m1)
plot(m1) #the residuals look bad

m1$aic
``` 


## Fitting an exponential model
The summary shows a clear effect of Traffic but Lanes is not significant. The QQplot shows skewed residuals. 
```{r, echo=FALSE}
m2 <- glm((Acc+1) ~ Lanes + Traffic, family=Gamma(link='log'), data=Accidents)
summary(m2)
plot(m2) #the residuals look terribly bad

m2$aic
``` 

```{r, echo=FALSE}
m3 <- glm((Acc+1) ~ Traffic, family=Gamma(link='log'), data=Accidents)
summary(m3)
plot(m3) #the residuals look terribly bad

m3$aic

plot(log(residuals(m3)))
``` 

## AIC selection 
```{r, echo=FALSE}
nullmodel <- lm(Acc ~ 1, data = Accidents)
fullmodel <- lm(Acc ~ ., data = Accidents)

# Forward selection
model.step.f <- step(nullmodel, scope = list(lower = nullmodel, upper = fullmodel), direction = 'forward')

# Backward elimination
model.step.b <- step(fullmodel, direction = 'backward')

# Stepwise selection
model.step <- step(nullmodel, scope = list(lower = nullmodel, upper = fullmodel), direction = 'both')

# AICs and BICs
AIC(model.step.f)
BIC(model.step.f)
AIC(model.step.b)
BIC(model.step.b)
AIC(model.step)
BIC(model.step)

```

they all give the model fitted with tunnel, year and lanes. the AIC and BIC aren't that different





